<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Service Test Console</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', monospace; }
        .card { background-color: #1e1e1e; border: 1px solid #333; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .card-header { border-bottom: 1px solid #333; font-weight: bold; letter-spacing: 1px; }
        .form-control, .form-select { background-color: #2c2c2c; border: 1px solid #444; color: #fff; }
        .form-control:focus, .form-select:focus { background-color: #333; color: #fff; border-color: #0d6efd; box-shadow: none; }
        .btn-primary { background-color: #6c5ce7; border: none; }
        .btn-primary:hover { background-color: #5b4bc4; }
        pre { background-color: #000; padding: 15px; border-radius: 5px; border: 1px solid #333; color: #00ff41; max-height: 300px; overflow-y: auto; }
        .status-badge { position: absolute; top: 10px; right: 10px; }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">

            <div class="text-center mb-4">
                <h1><i class="bi bi-cpu-fill text-primary"></i> AI Service Tester</h1>
                <p class="text-muted">Direct interface to <code>ai-service</code> via Gateway</p>
            </div>

            <!-- AUTHENTICATION -->
            <div class="card mb-4">
                <div class="card-header text-warning"><i class="bi bi-shield-lock"></i> 1. Authorization</div>
                <div class="card-body">
                    <label class="form-label">Bearer Token (JWT)</label>
                    <input type="text" id="jwtToken" class="form-control" placeholder="Paste your Keycloak access_token here...">
                    <div class="form-text text-secondary">Run your curl command to get a fresh token first.</div>
                </div>
            </div>

            <!-- REQUEST INPUTS -->
            <div class="card mb-4">
                <div class="card-header text-info"><i class="bi bi-input-cursor-text"></i> 2. Prompt Configuration</div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Platform Context</label>
                            <select id="platform" class="form-select">
                                <option value="LINKEDIN" selected>LinkedIn (Professional)</option>
                                <option value="TWITTER">Twitter (Short/Witty)</option>
                                <option value="INSTAGRAM">Instagram (Visual/Hashtags)</option>
                                <option value="FACEBOOK">Facebook (Casual)</option>
                            </select>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label">Endpoint URL</label>
                            <input type="text" id="endpointUrl" class="form-control" value="http://localhost:9000/api/v1/ai/generate">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Your Prompt</label>
                            <textarea id="prompt" class="form-control" rows="3" placeholder="e.g., Write a post about the benefits of using Kafka in microservices..."></textarea>
                        </div>
                        <div class="col-12">
                            <button class="btn btn-primary w-100 btn-lg" onclick="sendAiRequest()" id="btnSend">
                                <i class="bi bi-rocket-takeoff"></i> Generate Content
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RESPONSE OUTPUT -->
            <div class="card">
                <div class="card-header text-success"><i class="bi bi-code-square"></i> 3. System Response</div>
                <div class="card-body">

                    <!-- Visual Result -->
                    <label class="form-label">Generated Content (Parsed)</label>
                    <textarea id="resultText" class="form-control mb-3" rows="6" readonly style="background-color: #222; color: #fff;"></textarea>

                    <!-- Raw Log -->
                    <label class="form-label">Raw JSON Response / Debug Log</label>
                    <pre id="debugLog">Waiting for request...</pre>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // Helper to log data
    function log(data, isError = false) {
        const el = document.getElementById('debugLog');
        const timestamp = new Date().toLocaleTimeString();
        const prefix = isError ? '[ERROR]' : '[INFO]';
        const content = typeof data === 'object' ? JSON.stringify(data, null, 2) : data;

        el.innerText = `${prefix} ${timestamp}\n${content}\n\n` + el.innerText;
    }

    async function sendAiRequest() {
        const token = document.getElementById('jwtToken').value.trim();
        const url = document.getElementById('endpointUrl').value.trim();
        const prompt = document.getElementById('prompt').value.trim();
        const platform = document.getElementById('platform').value;
        const btn = document.getElementById('btnSend');
        const resultBox = document.getElementById('resultText');

        // Validation
        if (!token) return alert("Please paste a valid JWT Token first.");
        if (!prompt) return alert("Please enter a prompt.");

        // UI State: Loading
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> AI is thinking...';
        resultBox.value = "Generating...";
        document.getElementById('debugLog').innerText = ""; // Clear previous logs

        // Construct Payload
        const payload = {
            prompt: prompt,
            platform: platform
        };

        log("Sending Request to: " + url);
        log("Payload: " + JSON.stringify(payload));

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(payload)
            });

            const text = await response.text();

            // Handle Non-JSON responses (e.g., 401 HTML pages)
            let data;
            try {
                data = JSON.parse(text);
            } catch (e) {
                throw new Error(`Server returned non-JSON response (${response.status}):\n${text.substring(0, 200)}...`);
            }

            if (!response.ok) {
                throw new Error(data.message || data.error || `HTTP Error ${response.status}`);
            }

            log("Response Received:");
            log(data);

            // DISPLAY RESULT
            // We try to find the content field dynamically based on common naming conventions
            const generatedContent = data.content || data.generatedText || data.response || data.text;

            if (generatedContent) {
                resultBox.value = generatedContent;
            } else {
                resultBox.value = "Success, but could not find text field in JSON. Check logs below.";
            }

        } catch (error) {
            log(error.message, true);
            resultBox.value = "Error occurred. See logs below.";
        } finally {
            // UI State: Reset
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-rocket-takeoff"></i> Generate Content';
        }
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>